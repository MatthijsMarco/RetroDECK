app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: "6.5"
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14      # Needed for rpcs3
# base: io.qt.qtwebengine.BaseApp             # Needed for Yuzu - Disabled as we're using AppImage for Yuzu
# base-version: "6.5"                         # Needed for Yuzu - Disabled as we're using AppImage for Yuzu
command: retrodeck.sh

add-extensions:
  org.ppsspp.PPSSPP.Locale:
    directory: share/locale
    bundle: true
    no-autodownload: false
    subdirectories: false
    autodelete: true
    locale-subset: true

finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --share=ipc
  - --share=network
  - --device=all
  - --filesystem=home
  - --filesystem=/run/media
  - --filesystem=/media
  - --filesystem=home/.var/app/com.valvesoftware.Steam
  - --allow=multiarch
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.PowerManagement.Inhibit
  - --talk-name=org.freedesktop.login1.Manager
  - --talk-name=org.freedesktop.portal.Flatpak.UpdateMonitor
  - --filesystem=xdg-run/app/com.discordapp.Discord:create
  - --filesystem=xdg-config/gtk-3.0:ro
  # Dolphin
  - --allow=bluetooth
  # PPSSPP
  # It allows an SDL application to specify its window class, which can be useful for window managers and desktop environments to identify and group similar windows
  - --env=SDL_VIDEO_X11_WMCLASS=net.retrodeck.retrodeck
  - --env=SDL_VIDEO_WAYLAND_WMCLASS=net.retrodeck.retrodeck

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
  # XMLSTARLET
  - /lib/debug
  - /share/runtime
#cleanup-commands:
  # Yuzu
  #- /app/cleanup-BaseApp.sh

modules:

  # dependency of: CEMU, CITRA, DOLPHIN
  - rd-submodules/shared-modules/libusb/libusb.json

  # This module is used to define the RetroDECK version
  # If the version is set as cooker it will automatically generate the version tag based on the date
  # else it will just put what is written, "v" is not needed
  # The version number is hardcoded in /app/retrodeck/version
  #
  # UPDATE STEPS FOR MAIN:
  # [ ] Update the VERSION variable on line containing "VERSION=THISBRANCH"
  # [ ] Update the appdata.xml with the version number and notes
  #
  - name: version-initialization
    buildsystem: simple
    build-commands:
      - |

        # on main please update this with the version variable, eg: VERSION='0.7.0b'
        # on cooker will be THISBRANCH
        VERSION=THISBRANCH

        git checkout ${GITHUB_REF_NAME}
        mkdir -p ${FLATPAK_DEST}/retrodeck/
        if [[ $VERSION == *"cooker"* ]];
        then
          VERSION="$VERSION-VERSIONPLACEHOLDER"
        fi
        echo $VERSION >> ${FLATPAK_DEST}/retrodeck/version
        cat ${FLATPAK_DEST}/retrodeck/version
        echo "Version is $VERSION"
    sources:
      - type: git
        url: https://github.com/XargonWan/RetroDECK.git
        branch: THISBRANCH

  - name: xmlstarlet
    config-opts:
      - --disable-static-libs
      - --with-libxml-libs-prefix=/usr/lib
      - --with-libxml-include-prefix=/usr/include/libxml2
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/xmlstar/xmlstarlet-1.6.1.tar.gz
        sha256: 15d838c4f3375332fd95554619179b69e4ec91418a3a5296e7c631b7ed19e7ca
      - type: shell
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoreconf -vfi
    post-install:
      - ln -s "xml" "${FLATPAK_DEST}/bin/xmlstarlet" ||:

  # mesa repo got a double certificate issue and gnutils cannot handle that so GLU download fails,
  # this affects even the shared-modules's glu so I have to replace it temporarly
  # more info there: https://gitlab.com/gnutls/gnutls/-/issues/1335
  # dependency of: RETROARCH, CEMU, RPCS3
  - name: glu
    buildsystem: meson
    cleanup:
      - /include
      - /lib/debug
      - /lib/pkgconfig
      - /lib/*.a
    sources:
      - type: archive
        url: https://ftp.osuosl.org/pub/blfs/conglomeration/glu/glu-9.0.2.tar.xz
        sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4

  - name: libgudev
    buildsystem: meson
    config-opts:
      - -Dtests=disabled
      - -Dvapi=disabled
      - -Dintrospection=disabled
      - -Dgtk_doc=false
    cleanup:
      - /include
      - /etc
      - /libexec
      - /sbin
      - /lib/pkgconfig
      - /lib/systemd
      - /man
      - /share/aclocal
      - /share/doc
      - /share/gtk-doc
      - /share/man
      - /share/pkgconfig
      - '*.la'
      - '*.a'
    sources:
      - type: archive
        url: https://ftp.osuosl.org/pub/blfs/conglomeration/libgudev/libgudev-237.tar.xz
        sha256: 0d06b21170d20c93e4f0534dbb9b0a8b4f1119ffb00b4031aaeb5b9148b686aa

  - name: chdman-tool
    buildsystem: simple
    build-commands:
      - cmake -B . -G Ninja
      - cmake --build .
      - cp chdman /app/bin
    sources:
      - type: git
        url: https://github.com/CharlesThobe/chdman.git
        commit: f7cadf1720cbeba8a14f2685830ff424a0c7f6cd

  - name: rclone
    buildsystem: simple
    build-commands:
      - cp rclone ${FLATPAK_DEST}/bin/
    sources:
      - type: archive
        url: https://github.com/rclone/rclone/releases/download/v1.61.1/rclone-v1.61.1-linux-amd64.zip
        sha256: 6d6455e1cb69eb0615a52cc046a296395e44d50c0f32627ba8590c677ddf50a9

  # Source: https://github.com/flathub/com.valvesoftware.Steam.Utility.steamtinkerlaunch/blob/129c9192f874405d21612d95f9749dc2bcaf8cea/modules/rsync.yml#L5
  - name: rsync
    no-autogen: true
    config-opts:
      - --prefix=${FLATPAK_DEST}
      - --with-included-popt
      - --with-included-zlib
      - --disable-debug
      - --disable-xxhash # Unable to meet dependency -- rsync refuses to see the required xxhash.h file
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.2.7.tar.gz
        sha256: 4e7d9d3f6ed10878c58c5fb724a67dacf4b6aac7340b13e488fb2dc41346f2bb
        x-checker-data:
          type: anitya
          project-id: 4217
          stable-only: true
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - name: jq
    buildsystem: simple
    build-commands:
      - cp jq-linux64 ${FLATPAK_DEST}/bin/jq
      - chmod +x ${FLATPAK_DEST}/bin/jq
    sources:
      - type: file
        url: https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
        sha256: af986793a515d500ab2d35f8d2aecd656e764504b789b66d7e1a0b727a124c44
  
  - name: yq
    buildsystem: simple
    build-commands:
      - cp yq_linux_amd64 ${FLATPAK_DEST}/bin/yq
      - chmod +x ${FLATPAK_DEST}/bin/yq
    sources:
      - type: file
        url: https://github.com/mikefarah/yq/releases/download/v4.33.3/yq_linux_amd64
        sha256: 4ee662847c588c3ef2fec8bfb304e8739e3dbaba87ccb9a608d691c88f5b64dc

  # dependency of: CEMU, CITRA <-(13.0.0)
  - name: glslang
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_CTEST=OFF
    cleanup:
      - /include
      - /lib/cmake
    sources:
      - type: archive
        url: https://github.com/KhronosGroup/glslang/archive/13.0.0.tar.gz
        sha256: bcda732434f829aa74414ea0e06d329ec8ac28637c38a0de45e17c8fd25a4715
        x-checker-data:
          type: anitya
          stable-only: true
          project-id: 205796
          url-template: https://github.com/KhronosGroup/glslang/archive/$version.tar.gz

  # enables motion controls on non-wii controllers (switch, ps4, etc)
  # dependency of: DOLPHIN, RPCS3
  # TODO: requires a udev rule enabling Motion Sensors access
  - name: libevdev
    buildsystem: meson
    config-opts:
      - -Dtests=disabled
      - -Ddocumentation=disabled
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/libevdev/libevdev-1.13.1.tar.xz
        sha256: 06a77bf2ac5c993305882bc1641017f5bec1592d6d1b64787bad492ab34f2f36
        x-checker-data:
          type: anitya
          project-id: 20540
          stable-only: true
          url-template: https://www.freedesktop.org/software/libevdev/libevdev-$version.tar.xz

  # dependency of: CITRA, CEMU
  - name: rapidjson
    buildsystem: cmake-ninja
    config-opts:
      - -DRAPIDJSON_BUILD_DOC=OFF
      - -DRAPIDJSON_BUILD_EXAMPLES=OFF
      - -DRAPIDJSON_BUILD_TESTS=OFF
      - -DRAPIDJSON_BUILD_THIRDPARTY_GTEST=OFF
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - /share/doc
    sources:
      - type: archive
        url: https://github.com/Tencent/rapidjson/archive/refs/tags/v1.1.0.tar.gz
        sha256: bf7ced29704a1e696fbccf2a2b4ea068e7774fa37f6d7dd4039d0787f8bed98e
        x-checker-data:
          type: anitya
          project-id: 7422
          stable-only: true
          url-template: https://github.com/Tencent/rapidjson/archive/refs/tags/v$version.tar.gz
          
  # dependency of: CEMU, RPCS3
  - rd-submodules/shared-modules/glew/glew.json

  # FTP Server
  # https://github.com/flathub/eu.ithz.umftpd

  - name: umftpd
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-index --find-links="file://${PWD}" --ignore-installed setuptools
      - pip3 install --prefix=/app --no-index --find-links="file://${PWD}" .
      - mv flatpak/app/* /app/
    sources:
    - type: git
      url: https://gitlab.com/ergoithz/umftpd/
      tag: v0.3.3
      commit: 0596bc22ba83c59823462f7d22ca2aae71418049
    - type: file
      url: https://files.pythonhosted.org/packages/10/e5/be08751d07b30889af130cec20955c987a74380a10058e6e8856e4010afc/flit_core-3.8.0.tar.gz
      sha256: b305b30c99526df5e63d6022dd2310a0a941a187bd3884f4c8ef0418df6c39f3
    - type: file
      url: https://files.pythonhosted.org/packages/fc/ef/0335f7217dd1e8096a9e8383e1d472aa14717878ffe07c4772e68b6e8735/wheel-0.40.0.tar.gz
      sha256: cd1196f3faee2b31968d626e1731c94f99cbdb67cf5a46e4f5656cbee7738873
    - type: file
      url: https://files.pythonhosted.org/packages/0b/fc/8781442def77b0aa22f63f266d4dadd486ebc0c5371d6290caf4320da4b7/setuptools-67.6.1-py3-none-any.whl
      sha256: e728ca814a823bf7bf60162daf9db95b93d532948c4c0bea762ce62f60189078
    - type: file
      url: https://files.pythonhosted.org/packages/1d/66/8f42c941be949ef2b22fe905d850c794e7c170a526023612aad5f3a121ad/setuptools_scm-7.1.0-py3-none-any.whl
      sha256: 73988b6d848709e2af142aa48c986ea29592bbcfca5375678064708205253d8e
    - type: file
      url: https://files.pythonhosted.org/packages/97/75/10a9ebee3fd790d20926a90a2547f0bf78f371b2f13aa822c759680ca7b9/tomli-2.0.1-py3-none-any.whl
      sha256: 939de3e7a6161af0c887ef91b7d41a53e7c5a1ca976325f429cb46ea9bc30ecc
    - type: file
      url: https://files.pythonhosted.org/packages/ed/35/a31aed2993e398f6b09a790a181a7927eb14610ee8bbf02dc14d31677f1c/packaging-23.0-py3-none-any.whl
      sha256: 714ac14496c3e68c99c29b00845f7a2b85f3bb6f1078fd9f72fd20f0570002b2
    - type: file
      url: https://files.pythonhosted.org/packages/5b/fa/c9e82bbe1af6266adf08afb563905eb87cab83fde00a0a08963510621047/zipp-3.15.0-py3-none-any.whl
      sha256: 48904fc76a60e542af151aded95726c1a5c34ed43ab4134b597665c86d7ad556
    - type: file
      url: https://files.pythonhosted.org/packages/ed/d0/f7470892f9f496f3d403fca9b141367b1d5350fcd953ef5761674afafaa7/cryptography-40.0.1-cp36-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
      sha256: 63dac2d25c47f12a7b8aa60e528bfb3c51c5a6c5a9f7c86987909c6c79765554
      only-arches:
      - x86_64
    - type: file
      url: https://files.pythonhosted.org/packages/e9/79/b258803f573bfb202e29f9f56cd73e2b2e2fee1fe2e9cdf03f388919d8cc/cryptography-40.0.1-cp36-abi3-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
      sha256: 3a4805a4ca729d65570a1b7cac84eac1e431085d40387b7d3bbaa47e39890b88
      only-arches:
      - aarch64
    - type: file
      url: https://files.pythonhosted.org/packages/62/d5/5f610ebe421e85889f2e55e33b7f9a6795bd982198517d912eb1c76e1a53/pycparser-2.21-py2.py3-none-any.whl
      sha256: 8ee45429555515e1f6b185e78100aea234072576aa43ab53aefcae078162fca9
    - type: file
      url: https://files.pythonhosted.org/packages/88/89/c34caf63029fb7628ec2ebd5c88ae0c9bd17db98c812e4065a4d020ca41f/cffi-1.15.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
      sha256: dd86c085fae2efd48ac91dd7ccffcfc0571387fe1193d33b6394db7ef31fe2a4
      only-arches:
      - x86_64
    - type: file
      url: https://files.pythonhosted.org/packages/ef/41/19da352d341963d29a33bdb28433ba94c05672fb16155f794fad3fd907b0/cffi-1.15.1-cp310-cp310-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
      sha256: 21157295583fe8943475029ed5abdcf71eb3911894724e360acff1d61c1d54bc
      only-arches:
      - aarch64
    - type: file
      url: https://files.pythonhosted.org/packages/b7/6d/d7377332703ffd8821878794aca4fb54637da654bf3e467ffb32109c2147/pyOpenSSL-23.1.1-py3-none-any.whl
      sha256: 9e0c526404a210df9d2b18cd33364beadb0dc858a739b885677bc65e105d4a4c
    - type: file
      url: https://files.pythonhosted.org/packages/2f/bc/f03a15bf807698bbecdcf316041e3d79b25a40fa7b6e071e17702ff7b9d4/pyftpdlib-1.5.7.tar.gz
      sha256: 7ea3ce4137db8209af1f6b9ea020590f462c63ed7c7a1240bd596e4d3a7b656e
    - type: file
      url: https://files.pythonhosted.org/packages/1e/9f/ad61867b12823f6e2c0ef2b80a704273b9385de707ac4539afa445c0665d/asyncssh-2.13.1-py3-none-any.whl
      sha256: c90eb5e2b4f9a7cc6e6af01fd844563d722c0d667f8c5f51fe5b3c2a79fa0575
    - type: file
      url: https://files.pythonhosted.org/packages/31/25/5abcd82372d3d4a3932e1fa8c3dbf9efac10cc7c0d16e78467460571b404/typing_extensions-4.5.0-py3-none-any.whl
      sha256: fb33085c39dd998ac16d1431ebc293a8b3eedd00fd4a32de0ff79002c19511b4
    - type: file
      url: https://files.pythonhosted.org/packages/3f/ff/a8d7faaa3573b6e4c775cacbf911a0afbcb4928ce71b3de43119227a396a/zeroconf-0.39.4-py3-none-any.whl
      sha256: d60eae9e9c99d1a168ce9ff9de7e7398c23754a0c2004ded230f8d529c5260a0
    - type: file
      url: https://files.pythonhosted.org/packages/9c/1f/19ebc343cc71a7ffa78f17018535adc5cbdd87afb31d7c34874680148b32/ifaddr-0.2.0-py3-none-any.whl
      sha256: 085e0305cfe6f16ab12d72e2024030f5d52674afad6911bb1eee207177b8a748
    - type: file
      url: https://files.pythonhosted.org/packages/d6/c1/8991e7c5385b897b8c020cdaad718c5b087a6626d1d11a23e1ea87e325a7/async_timeout-4.0.2-py3-none-any.whl
      sha256: 8ca1e4fcf50d07413d66d1a5e416e42cfdf5851c981d679a09851a6853383b3c
    - type: file
      url: https://files.pythonhosted.org/packages/ae/0d/dcfe8116c9f31cb251c372742807a15abce28d1efeb2f3c6a7554cbad17f/ustache-0.1.5-py3-none-any.whl
      sha256: 3d277909dd7bc3012eee101ffa68a241f66222b768fe1c7c77afff9a1d2028fc

  # ES-DE - START
  # https://gitlab.com/es-de/emulationstation-de

  #This is disabled because we added the extension (line 11), check if the videos are ok.
  - name: ffmpeg
    config-opts:
      - --disable-static
      - --disable-programs
      - --disable-doc
      - --enable-gpl
      - --enable-shared
      - --enable-libvorbis
      - --enable-libopus
      - --enable-libvpx
      - --enable-postproc
    sources:
      - type: git
        url: https://github.com/FFmpeg/FFmpeg.git
        tag: n5.1.1

  - name: freeimage
    no-autogen: true
    build-options:
      cxxflags: -std=c++14
    make-args:
      - DESTDIR=/app
    sources:
      - type: archive
        url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
        sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
      - type: shell
        commands:
          - sed -i 's|-o root -g root ||' ./Makefile.gnu
          - sed -i 's|/usr|/app|' ./Makefile.gnu

  # dependency of: CEMU
  - name: pugixml
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
    sources:
      - type: archive
        url: https://github.com/zeux/pugixml/releases/download/v1.13/pugixml-1.13.tar.gz
        sha256: 40c0b3914ec131485640fa57e55bf1136446026b41db91c1bef678186a12abbe
        x-checker-data:
          type: anitya
          project-id: 3728
          url-template: https://github.com/zeux/pugixml/releases/download/v$version/pugixml-$version.tar.gz

  - name: libgit2
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DTHREADSAFE=ON
    sources:
      - type: git
        url: https://github.com/libgit2/libgit2.git
        tag: v1.6.3

  # Needed from ES-DE 2.1.0+
  - name: libpoppler-glib
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_BOOST=OFF
    sources:
      - type: archive
        url: https://gitlab.freedesktop.org/poppler/poppler/-/archive/poppler-22.11.0/poppler-poppler-22.11.0.tar.bz2
        sha256: b8f618d5c62030034d5c8da4d3f6a740260b7620b9a31021679ce1914d327f81
    cleanup:
      - /lib/pkgconfig
      - /include
      - '*.a'
      - '*.la'

  # When updating this module remember to check those:
  # https://gitlab.com/es-de/emulationstation-de/-/blob/[VERSION]/resources/systems/unix/es_find_rules.xml
  # But we don't include them 1:1 as RetroDECK got some specific configs in some cases
  - name: emulationstation-de
    buildsystem: cmake-ninja
    config-opts:
      - -DRETRODECK=on
    cleanup:
      - es-app
      - es-core
    sources:
      - type: git
        url: https://gitlab.com/es-de/emulationstation-de
        branch: 5545187d82fabf93256b7d176f39a0a98bcd6c54
      - type: shell
        commands:
          - sed -i 's#"EMULATIONSTATION-DE  V" + Utils::String::toUpper(PROGRAM_VERSION_STRING)#"RetroDECK
            v'$(cat ${FLATPAK_DEST}/retrodeck/version)', ES-DE  v" + Utils::String::toUpper(PROGRAM_VERSION_STRING)#g'
            es-app/src/guis/GuiMenu.cpp
      - type: patch
        path: rd-submodules/es-de/GuiMenu.cpp.patch
      - type: patch
        path: rd-submodules/es-de/GuiMenu.h.patch
      - type: patch
        path: rd-submodules/es-de/ViewController.cpp.patch
      - type: patch
        path: rd-submodules/es-de/Window.cpp.patch

  # ES-DE - END

  # ES-DE Themes - START

  - name: art-book-next-es-de
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/share/emulationstation/themes/art-book-next-es-de/
      - mv -f * ${FLATPAK_DEST}/share/emulationstation/themes/art-book-next-es-de/
    sources:
      - type: git
        url:  https://github.com/anthonycaccese/art-book-next-es-de.git
        commit: 4fe896af7447404f6ea083335cd661c91b0f7860

  # ES-DE Themes - END

  # External manifests start

  # RetroArch - START
  # https://github.com/flathub/org.libretro.RetroArch

  - name: retroarch
    config-opts:
      - '--enable-dbus'
    make-args:
      - 'GLOBAL_CONFIG_DIR=${FLATPAK_DEST}/etc'
      - HAVE_TRANSLATE=1
      - HAVE_ACCESSIBILITY=1
    sources:
      - type: git
        url: 'https://github.com/libretro/RetroArch.git'
        commit: 712b9350a5c2b1b9129d939a2ae622093dfabd04
      - type: file
        path: rd-submodules/retroarch/retroarch.cfg
    post-install:
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
      - >-
        mv ${FLATPAK_DEST}/share/pixmaps/retroarch.svg
        ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/
      - rmdir --ignore-fail-on-non-empty ${FLATPAK_DEST}/share/pixmaps/
      - mkdir -p ${FLATPAK_DEST}/etc
      - >-
        sed s:@prefix@:${FLATPAK_DEST}:g retroarch.cfg >
        ${FLATPAK_DEST}/etc/retroarch.cfg
    modules:
      - rd-submodules/retroarch/modules/libpng/libpng-1.6.35.json
      - rd-submodules/retroarch/modules/nvidia-cg-toolkit/nvidia-cg-toolkit-3.1.0013.json
      - rd-submodules/shared-modules/SDL/SDL-1.2.15.json
      - rd-submodules/shared-modules/SDL/SDL_image-1.2.12.json
      - rd-submodules/shared-modules/SDL/SDL_mixer-1.2.12.json
      - rd-submodules/shared-modules/SDL/SDL_net-1.2.8.json
      - rd-submodules/shared-modules/SDL/SDL_ttf-2.0.11.json
      #- rd-submodules/shared-modules/libusb/libusb.json moved outside
      # certificate glu issue
      #- rd-submodules/shared-modules/gudev/gudev.json
      - rd-submodules/retroarch/modules/libbz2/libbz2-1.0.8.json
      - rd-submodules/retroarch/modules/xrandr/xrandr-1.5.1.json
      - rd-submodules/retroarch/modules/libaio/libaio-0.3.112.json
      # certificate issue, check glu module for more info
      #- rd-submodules/shared-modules/glu/glu-9.json
      - rd-submodules/shared-modules/libdecor/libdecor-0.1.1.json
  - name: retroarch-filers-video
    subdir: gfx/video_filters
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/RetroArch.git'
        commit: 712b9350a5c2b1b9129d939a2ae622093dfabd04
  - name: retroarch-filers-audio
    subdir: libretro-common/audio/dsp_filters
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/RetroArch.git'
        commit: 712b9350a5c2b1b9129d939a2ae622093dfabd04
  - name: retroarch-assets
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/retroarch-assets.git'
        commit: 7b735ef18bcc6508b1c9a626eb237779ff787179
  - name: libretro-database
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/libretro-database.git'
        commit: e3b5cb00da4f3ab99491bf67c19630ffa7ee19f2
  - name: libretro-core-info
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/libretro-core-info.git'
        commit: dacae85b406131feb12395a415fdf57fc4745201
  - name: retroarch-joypad-autoconfig
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/retroarch-joypad-autoconfig.git'
        commit: 5666e46bb89caf4e9af358fdb97a2b384cb62f36
  - name: common-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: https://github.com/libretro/common-shaders.git
        commit: 86cfa146a8dfddf6377ddb5dbcff552feae2e5bf
  - name: slang-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/slang-shaders.git'
        commit: 9266fa24b64b274fd429b73469ded3561de7b8f4
  - name: glsl-shaders
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/glsl-shaders.git'
        commit: c26b9e1913eda8c25d6cd218818745a3b451f982
  - name: common-overlays
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
    sources:
      - type: git
        url: 'https://github.com/libretro/common-overlays.git'
        commit: 115d8670c2e032e4a41ba45f766f5cfd9dae28b8

  # RetroArch - END

  # Not part of the offical RetroArch manifest
  - name: retroarch-cores
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/libretro/cores/
      - mv ./RetroArch-Linux-x86_64.AppImage.home/.config/retroarch/cores/* /app/share/libretro/cores/
    sources:
      - type: archive
        url: https://buildbot.libretro.com/stable/1.16.0/linux/x86_64/RetroArch_cores.7z
        sha256: a149d34662516d791e8f90507d1107949cb158196d6bbf75105c649fb26504b6
    
  - name: retroarch-sameduck-core
    buildsystem: simple
    build-commands:
      - mv sameduck_libretro.so /app/share/libretro/cores/sameduck_libretro.so
    sources:
      - type: archive
        url: https://buildbot.libretro.com/nightly/linux/x86_64/latest/sameduck_libretro.so.zip
        sha256: SAMEDUCKSHAPLACEHOLDER

  - name: ppsspp-bios
    buildsystem: simple
    build-commands:
    - mkdir -p ${FLATPAK_DEST}/retrodeck/extras/PPSSPP
    - mv -f assets/* ${FLATPAK_DEST}/retrodeck/extras/PPSSPP/
    sources:
      - type: archive
        url: https://github.com/hrydgard/ppsspp/archive/refs/heads/master.zip
        sha256: PPSSPPBIOSHASHPLACEHOLDER

  - name: msx-bios
    buildsystem: simple
    build-commands:
    - mkdir -p ${FLATPAK_DEST}/retrodeck/extras/MSX
    - mv -f Databases ${FLATPAK_DEST}/retrodeck/extras/MSX/Databases
    - mv -f Machines ${FLATPAK_DEST}/retrodeck/extras/MSX/Machines
    sources:
      - type: archive
        url: http://bluemsx.msxblue.com/rel_download/blueMSXv282full.zip
        sha256: MSXBIOSHASHPLACEHOLDER
        strip-components: 0
  
  - name: amiga-bios
    buildsystem: simple
    build-commands:
    - mkdir -p ${FLATPAK_DEST}/retrodeck/extras/Amiga
    - cp -f Linux/x86-64/capsimg.so ${FLATPAK_DEST}/retrodeck/extras/Amiga/capsimg.so
    sources:
      - type: archive
        url: https://github.com/rsn8887/capsimg/releases/download/1.1/Capsimg_for_Retroarch.zip
        sha256: 16c1b511b8e1374a2b6461a66bb6f07b7d2627eb4e941fd1497a432330acaad1
        strip-components: 0

  # PPSSPP - START
  # https://github.com/flathub/org.ppsspp.PPSSPP

  - name: ppsspp
    buildsystem: cmake-ninja
    config-opts:
      - -DUSE_SYSTEM_FFMPEG=OFF
      - -DUSE_SYSTEM_LIBZIP=ON
      - -DUSE_SYSTEM_ZSTD=ON

      - -DUSE_WAYLAND_WSI=ON
      - -DUSING_QT_UI=OFF

      - -DBUILD_TESTING=OFF
      - -DOpenGL_GL_PREFERENCE=GLVND
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DUSING_EGL=ON
            - -DUSING_GLES2=ON
    post-install:
      - install -Dm644 icons/icon-512.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/ppsspp.svg
    cleanup:
      - /share/ppsspp/assets/lang/README.md
    sources:
      - type: git
        url: &ppsspp-url https://github.com/hrydgard/ppsspp.git
        tag: v1.16.3
        commit: a9b6421dfde68be9d065b51e9d519699ce2e9053
        x-checker-data:
          type: json
          url: https://api.github.com/repos/hrydgard/ppsspp/releases/latest
          version-query: .tag_name | sub("^v"; "")
          tag-query: .tag_name
          timestamp-query: .published_at

  - name: ppsspp-localization
    buildsystem: simple
    build-commands:
      - |
        for LANG_FILE in assets/lang/*.ini; do
          LANG_FILE_NAME="$(basename "$LANG_FILE")"
          LANG_PREFIX="${LANG_FILE_NAME:0:2}"
          LANG_DEST="$FLATPAK_DEST/share/locale/$LANG_PREFIX/ppsspp/$LANG_FILE_NAME";
          ln -fsr "$LANG_DEST" "$FLATPAK_DEST/share/ppsspp/$LANG_FILE"
          install -Dm644 "$LANG_FILE" "$LANG_DEST"
        done
    sources:
      - type: shell
        commands:
          - cp -a $FLATPAK_DEST/share/ppsspp/assets .

  # PPSSPP - END

  # Yuzu - START
  # https://github.com/yuzu-emu/yuzu-mainline/releases

  - name: Yuzu
    buildsystem: simple
    build-commands:
      - chmod +x yuzu*.AppImage
      - ./yuzu*.AppImage --appimage-extract
      - mkdir -p "${FLATPAK_DEST}/yuzu"
      - cp -r squashfs-root/* "${FLATPAK_DEST}/yuzu"
      - ln -s "${FLATPAK_DEST}/yuzu/usr/bin/yuzu" "${FLATPAK_DEST}/bin/yuzu"
    sources:
      - type: file
        url: https://github.com/yuzu-emu/yuzu-mainline/releases/download/mainline-0-1567/yuzu-mainline-20230923-ace91dd0c.AppImage
        sha256: 965bdfa63e713a0672fb5a037ecb527b4860600c6a2526f7c053bfe082b5a9d8

  # Yuzu - END

  # CITRA - START
  # https://github.com/flathub/org.citra_emu.citra

  - rd-submodules/shared-modules/SDL2/SDL2-with-libdecor.json

  - name: citra
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - '-DCMAKE_BUILD_TYPE=Release'
      - '-DENABLE_QT_TRANSLATION=ON'
      - '-DCITRA_ENABLE_COMPATIBILITY_REPORTING=ON'
      - '-DUSE_DISCORD_PRESENCE=ON'
      - '-DENABLE_COMPATIBILITY_LIST_DOWNLOAD=OFF'
      - '-DUSE_SYSTEM_SDL2=ON'
    cleanup:
      - /share/man
      - /share/pixmaps
    post-install:
      - install -Dm755 ../citra-launcher.sh /app/bin/citra-launcher
      - >-
        install -Dm644 ../org.citra_emu.citra.svg
        /app/share/icons/hicolor/scalable/apps/citra.svg
      - >-
        install -Dm644 ../dist/icon.png
        /app/share/icons/hicolor/512x512/apps/citra.png
      - >-
        mv /app/share/mime/packages/citra.xml
        /app/share/mime/packages/org.citra_emu.citra.xml
      - >-
        sed 's/citra/org.citra_emu.citra/g' -i
        /app/share/mime/packages/org.citra_emu.citra.xml
    sources:
      - type: archive
        url: >-
          https://github.com/citra-emu/citra-nightly/releases/download/nightly-2009/citra-unified-source-20231012-40ba522.tar.xz
        sha256: 927739892fff5d1b325b07182ab29a7355f58866debe60da1d6620680773ac97
        x-checker-data:
          type: json
          url: https://api.github.com/repos/citra-emu/citra-nightly/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | .browser_download_url |
            match("https://.+citra-unified-source-.+.xz$") | .string
          is-main-source: true
      - type: file
        path: rd-submodules/citra/org.citra_emu.citra.svg
      - type: file
        path: rd-submodules/citra/citra-launcher.sh

  # CITRA - END

  # PCSX2 - START
  # Inspired by:
  # https://github.com/flathub/com.zettlr.Zettlr/blob/master/com.zettlr.Zettlr.yaml
  # https://pcsx2.net/downloads/

  - name: pcsx2-qt
    buildsystem: simple
    build-commands:
      - chmod +x pcsx2*.AppImage
      - ./pcsx2*.AppImage --appimage-extract
      - mkdir -p "${FLATPAK_DEST}/pcsx2-qt"
      - cp -r squashfs-root/* "${FLATPAK_DEST}/pcsx2-qt"
      - ln -s "${FLATPAK_DEST}/pcsx2-qt/usr/bin/pcsx2-qt" "${FLATPAK_DEST}/bin/pcsx2-qt"
    sources:
      - type: file
        url: https://github.com/PCSX2/pcsx2/releases/download/v1.7.5059/pcsx2-v1.7.5059-linux-appimage-x64-Qt.AppImage
        sha256: a51addc9bd15b77e842160acecb1f18486f8a024e5e73e8aea5de71de2b164c7

  # PCSX2 - END

  # Dolphin - START
  # https://github.com/flathub/org.DolphinEmu.dolphin-emu
  # WHEN UPADTING: remember to update rd-submodules/dolphin contents

  # needed for screensaver inhibition
  - name: xdg-screensaver-shim
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/Unrud/xdg-screensaver-shim/archive/0.0.2.tar.gz
        sha256: 0ed2a69fe6ee6cbffd2fe16f85116db737f17fb1e79bfb812d893cf15c728399

  - name: dolphin-emu
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_ALSA=OFF
      - -DENABLE_SDL=ON
      - -DENABLE_EVDEV=ON
      - -DDISTRIBUTOR=Flathub
    cleanup:
      - /share/man
    post-install:
      - install -D -t ${FLATPAK_DEST}/bin/ dolphin-emu-wrapper
      - sed -i -e 's/"2048"/"512"/g' /app/share/icons/hicolor/scalable/apps/dolphin-emu.svg
    sources:
      - type: git
        # Sometimes Dolphin or its submodules clone are failing in https so it must done in ssh
        # fatal: remote transport reported error
        # url: ssh://git@github.com/dolphin-emu/dolphin.git
        url: https://github.com/dolphin-emu/dolphin.git
        commit: 032c77b462a220016f23c5079e71bb23e0ad2adf
        x-checker-data:
          type: json
          url: https://dolphin-emu.org/update/latest/beta
          commit-query: .hash
          version-query: .shortrev
          timestamp-query: .date
          is-main-source: true
      # detects whether dolphin is running in a flatpak sandbox
      # and makes it use xdg directories if it is.
      # prevents dolphin from attempting to write conf files
      # in non-writable paths, typically happens when a user
      # has leftover files from a previous non-flatpak install
      - type: patch
        path: rd-submodules/dolphin/detectflatpak.patch
      # version strings must match exactly for online multiplayer
      - type: patch
        path: rd-submodules/dolphin/nodirtyversion.patch
      - type: script
        commands:
          - |
            for i in {0..9}; do
              test -S $XDG_RUNTIME_DIR/discord-ipc-$i ||
                ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
            done
            dolphin-emu "$@"
        dest-filename: dolphin-emu-wrapper

  - name: universal_dynamic_input
    buildsystem: simple
    build-commands:
      - mkdir -p ${FLATPAK_DEST}/retrodeck/extras/DynamicInputTextures
      - cp -r * ${FLATPAK_DEST}/retrodeck/extras/DynamicInputTextures/
    sources:
      - type: git
        url: https://github.com/Venomalia/UniversalDynamicInput.git
        commit: UNIVERSALDYNAMICINPUTCOMMITPLACEHOLDER

  # Dolphin - END

  # XEMU - START
  # https://github.com/flathub/app.xemu.xemu

  - name: libpcap
    buildsystem: cmake-ninja
    cleanup:
      - /bin
      - /include
      - /lib/debug
      - /lib/pkgconfig
      - /lib/*.a
      - /share
    sources:
      - type: archive
        url: https://www.tcpdump.org/release/libpcap-1.10.4.tar.gz
        sha256: ed19a0383fad72e3ad435fd239d7cd80d64916b87269550159d20e47160ebe5f
        x-checker-data:
          type: anitya
          project-id: 1702
          stable-only: true
          url-template: https://www.tcpdump.org/release/libpcap-$version.tar.gz

  - name: PyYAML
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://github.com/yaml/pyyaml/archive/refs/tags/6.0.tar.gz
        sha256: f33eaba25d8e0c1a959bbf00655198c287dfc5868f5b7b01e401eaa1796cc778

  - name: xemu
    buildsystem: autotools
    builddir: true
    no-make-install: true
    build-options:
      cflags: -O3 -DXBOX=1 -Wno-error=redundant-decls
    config-opts:
      - --audio-drv-list=sdl
      - --disable-werror
      - --target-list=i386-softmmu
    make-args:
      - qemu-system-i386
    post-install:
      - |-
        for px in 16 32 48 64 128 256 512; do
          install -Dm644 ../ui/icons/xemu_${px}x${px}.png $FLATPAK_DEST/share/icons/hicolor/${px}x${px}/apps/app.xemu.xemu.png
        done
      - install -Dm644 ../ui/icons/xemu.svg $FLATPAK_DEST/share/icons/hicolor/scalable/apps/app.xemu.xemu.svg
      - mv qemu-system-i386 $FLATPAK_DEST/bin/xemu
      - mkdir -p $FLATPAK_DEST/share/licenses/xemu
      - cd .. && python3 scripts/gen-license.py > $FLATPAK_DEST/share/licenses/xemu/LICENSE.txt
    sources:
      - type: git
        url: https://github.com/xemu-project/xemu.git
        tag: v0.7.98
        commit: 7bfb7c85378f64f93556c365ea0cc18cb2181dc8
        x-checker-data:
          type: json
          url: https://api.github.com/repos/xemu-project/xemu/releases/latest
          tag-query: .tag_name
          timestamp-query: .published_at
          version-query: .tag_name

  - name: xemu-dummy-hdd
    buildsystem: simple
    build-commands:
    - mkdir -p ${FLATPAK_DEST}/retrodeck/extras/XEMU
    - mv -f "xbox_hdd.qcow2" "${FLATPAK_DEST}/retrodeck/extras/XEMU/xbox_hdd.qcow2"
    sources:
      - type: archive
        url: https://github.com/mborgerson/xemu-hdd-image/releases/latest/download/xbox_hdd.qcow2.zip
        sha256: XEMUHDDHASHPLACEHOLDER

  # XEMU - END

  # MELONDS - START
  # https://github.com/flathub/net.kuribo64.melonDS
  # ちっちゃい、かわいい！

  - name: libslirp
    buildsystem: meson
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/slirp/libslirp.git
        tag: v4.7.0

  - name: melonds
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DUSE_QT6=ON
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DENABLE_LTO_RELEASE=OFF
    sources:
      - type: git
        url: https://github.com/melonDS-emu/melonDS.git
        commit: 430de6b2702bb93faa8c2004aff3fbd084db4a1e
      - type: patch
        path: rd-submodules/melonds/hotkeys.patch

  # MELONDS - END

  # RPCS3 - START
  # https://github.com/flathub/net.rpcs3.RPCS3

  - name: rpcs3
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      append-ld-library-path: /usr/lib/sdk/llvm16/lib
      append-path: /usr/lib/sdk/llvm16/bin
      cflags: &optflags -O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong
        -grecord-gcc-switches -fasynchronous-unwind-tables -fstack-clash-protection
        -fcf-protection -fno-omit-frame-pointer
      cflags-override: true
      cxxflags: *optflags
      cxxflags-override: true
      env:
        AR: llvm-ar
        CC: clang
        CXX: clang++
        RANLIB: llvm-ranlib
      ldflags: -fuse-ld=lld
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_LLVM=OFF
      - -DUSE_NATIVE_INSTRUCTIONS=OFF
      - -DUSE_PRECOMPILED_HEADERS=OFF
      - -DUSE_SDL=ON
      - -DUSE_SYSTEM_CURL=ON
      - -DUSE_SYSTEM_FFMPEG=OFF # Disabled this to force RPCS3 to use our built FFMPEG
      - -DUSE_SYSTEM_LIBPNG=ON
      - -DUSE_SYSTEM_SDL=ON
      - -DUSE_SYSTEM_ZLIB=ON
      - -Wno-dev
    post-install:
      - cp /usr/lib/sdk/llvm16/lib/libLLVM-16.so /app/lib/
      - |-
        set -eux
        COMM_TAG="$(awk -F'[\{,]' '/version{.*}/{printf "%d.%d.%d", $2, $3, $4}' ../rpcs3/rpcs3_version.cpp)"
        COMM_COUNT="$(git rev-list --count HEAD)";
        COMM_HASH="$(git rev-parse --short=8 HEAD)";
    sources:
      - type: git
        url: https://github.com/RPCS3/rpcs3.git
        commit: 75d239356a773b8211354049477d79006597505e

  # RPCS3 - END

  # PRIMEHACK - START
  # https://github.com/flathub/io.github.shiiion.primehack

  - name: primehack
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DENABLE_ALSA=OFF
      - -DENABLE_SDL=ON
      - -DENABLE_EVDEV=ON
      - -DDISTRIBUTOR=Flathub
      - -DQT_DIR=
    cleanup:
      - /share/man
    post-install:
      - install -D primehack-wrapper /app/bin/primehack-wrapper
    sources:
      - type: git
        url: https://github.com/XargonWan/primehack
        commit: af7710ef7b04a632b4294eae5e0eff8fe9c4d1f8
        #url: https://github.com/TheDrifter363/primehack.git
        #commit: 6295c695307a67f11ee202b05cbdd7b5c1edae5c
       # detects whether dolphin is running in a flatpak sandbox
       # and makes it use xdg directories if it is.
       # prevents dolphin from attempting to write conf files
       # in non-writable paths, typically happens when a user
       # has leftover files from a previous non-flatpak install
      - type: patch
        path: rd-submodules/primehack/detectflatpak.patch
       # version strings must match exactly for online multiplayer
      - type: patch
        path: rd-submodules/primehack/nodirtyversion.patch
      - type: script
        commands:
          - for i in {0..9}; do
          - test -S $XDG_RUNTIME_DIR/discord-ipc-$i || ln -sf {app/com.discordapp.Discord,$XDG_RUNTIME_DIR}/discord-ipc-$i;
          - done
          - primehack "$@"
        dest-filename: primehack-wrapper

  # # PRIMEHACK - END

  # Duckstation-AppImage - START
  # https://github.com/stenzek/duckstation/releases/tag/preview

  - name: Duckstation-AppImage
    buildsystem: simple
    build-commands:
      - chmod +x DuckStation-*.AppImage
      - ./DuckStation-x64*.AppImage --appimage-extract
      - mkdir -p "${FLATPAK_DEST}/duckstation"
      - cp -r squashfs-root/* "${FLATPAK_DEST}/duckstation"
      - ln -s "${FLATPAK_DEST}/duckstation/usr/bin/duckstation-qt" "${FLATPAK_DEST}/bin/duckstation-qt"
    sources:
      - type: file
        url: https://github.com/stenzek/duckstation/releases/download/preview/DuckStation-x64.AppImage
        sha256: DUCKSTATIONSHAPLACEHOLDER

  # Duckstation-AppImage - END

  # Cemu - START
  # https://github.com/cemu-project/Cemu/releases
  # https://github.com/flathub/info.cemu.Cemu

  - name: hidapi
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/libusb/hidapi/archive/refs/tags/hidapi-0.14.0.tar.gz
        sha256: a5714234abe6e1f53647dd8cba7d69f65f71c558b7896ed218864ffcf405bcbd
        x-checker-data:
          type: anitya
          project-id: 5594
          stable-only: true
          url-template: https://github.com/libusb/hidapi/archive/refs/tags/hidapi-$version.tar.gz

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=${FLATPAK_DEST} --with-toolset=gcc --with-libraries=filesystem,system,program_options,nowide
      - ./b2 install variant=release link=shared runtime-link=shared cxxflags="$CXXFLAGS"
        linkflags="$LDFLAGS" -j ${FLATPAK_BUILDER_N_JOBS}
    cleanup:
      - /include
      - /lib/cmake
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2
        sha256: 6478edfe2f3305127cffe8caf73ea0176c53769f4bf1585be237eb30798c3b8e
        x-checker-data:
          type: anitya
          project-id: 6845
          stable-only: true
          url-template: https://boostorg.jfrog.io/artifactory/main/release/$version/source/boost_${major}_${minor}_$patch.tar.bz2

  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_DOC=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_REGRESS=OFF
      - -DBUILD_TOOLS=OFF
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/pkgconfig
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.10.1.tar.xz
        mirror-urls:
          - https://github.com/nih-at/libzip/releases/download/v1.10.1/libzip-1.10.1.tar.xz
        sha256: dc3c8d5b4c8bbd09626864f6bcf93de701540f761d76b85d7c7d710f4bd90318
        x-checker-data:
          type: anitya
          project-id: 10649
          url-template: https://libzip.org/download/libzip-$version.tar.xz

  - name: glm
    buildsystem: cmake-ninja
    cleanup: ['*']
    no-make-install: true
    post-install:
      - install -d ${FLATPAK_DEST}/include
      - cp -R glm ${FLATPAK_DEST}/include
      - cp -R cmake/glm ${FLATPAK_DEST}/lib/cmake
    sources:
      - type: archive
        url: https://github.com/g-truc/glm/releases/download/0.9.9.8/glm-0.9.9.8.zip
        sha256: 37e2a3d62ea3322e43593c34bae29f57e3e251ea89f4067506c94043769ade4c

  - name: fmt
    buildsystem: cmake-ninja
    config-opts:
      - -DFMT_TEST=Off
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/fmtlib/fmt/archive/9.1.0.tar.gz
        sha256: 5dea48d1fcddc3ec571ce2058e13910a0d4a6bab4cc09a809d8b1dd1c88ae6f2
        x-checker-data:
          type: anitya
          project-id: 11526
          url-template: https://github.com/fmtlib/fmt/archive/$version.tar.gz
          versions: {<: '10.0'}

  - name: wxwidgets
    cleanup:
      - /bin
      - /include
      - /lib/cmake
      - /lib/wx
      - /share
    sources:
      - type: archive
        url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.2.1/wxWidgets-3.2.2.1.tar.bz2
        sha256: dffcb6be71296fff4b7f8840eb1b510178f57aa2eb236b20da41182009242c02
        x-checker-data:
          type: anitya
          project-id: 5150
          stable-only: true
          url-template: https://github.com/wxWidgets/wxWidgets/releases/download/v$version/wxWidgets-$version.tar.bz2

  - name: Cemu
    buildsystem: cmake-ninja
    config-opts:
      - -DPORTABLE=false
      - -DENABLE_VCPKG=false
    build-options:
      env:
        - LC_ALL=C
    sources:
      - type: git
        url: https://github.com/cemu-project/Cemu
        # TODO: Update tag pattern on next stable ^v([\d.]+)$
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+-\d+)$
        tag: v2.0-47
        commit: 85aa4f095b119e98620451a0c19c80f656d944a6
      - type: shell
        commands:
          - sed "s/set(EXPERIMENTAL_VERSION.*/set(EXPERIMENTAL_VERSION \"$(git describe
            --tag | sed "s/v2.0-//")\" CACHE STRING \"\")/g" -i CMakeLists.txt
      - type: script
        commands:
          - |
            for d in DiscordCanary Discord; do
              for i in {0..9}; do
                test -S $XDG_RUNTIME_DIR/discord-ipc-$i ||
                  ln -sf {app/com.discordapp.$d,$XDG_RUNTIME_DIR}/discord-ipc-$i;
              done
            done
            Cemu_relwithdebinfo "$@"
        dest-filename: Cemu-wrapper
      - type: script
        dest-filename: dev_release_metainfo.py
        commands:
          - |
            import os
            import xml.etree.ElementTree as ET
            meta_file = os.environ.get('AS_META_FILE')
            version = os.environ.get('AS_META_VERSION')
            release_type = os.environ.get('AS_META_TYPE')
            release_date = os.environ.get('AS_META_DATE')
            release_url = os.environ.get('AS_META_URL')
            tree = ET.parse(meta_file)
            root = tree.getroot()
            el_releases = root.find('releases')
            for el_release in el_releases:
              el_releases.remove(el_release)
            el_release = ET.SubElement(el_releases, 'release')
            el_url = ET.SubElement(el_release, 'url')
            el_url.text = release_url
            el_release.attrib['type'] = release_type
            el_release.attrib['date'] = release_date
            el_release.attrib['version'] = version
            ET.indent(tree, space='  ', level=0)
            tree.write(meta_file, encoding='utf8')
    post-install:
      - cp -r bin/gameProfiles ${FLATPAK_DEST}/share/Cemu/
      - cp -r bin/resources ${FLATPAK_DEST}/share/Cemu/
      - install -Dm644 -t ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/ dist/linux/info.cemu.Cemu.png
      - install -D -t ${FLATPAK_DEST}/bin/ bin/Cemu_relwithdebinfo Cemu-wrapper

  # Cemu - END

  # Ryujinx - START
  # https://github.com/flathub/org.ryujinx.Ryujinx

  - name: Ryujinx
    buildsystem: simple
    build-options:
      no-debuginfo: true
      no-debuginfo-compression: true
      strip: false
      arch:
        x86_64:
          env:
            RUNTIME: linux-x64
      env:
        PKG_CONFIG_PATH: /app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig
        DOTNET_CLI_TELEMETRY_OPTOUT: 'true'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
        RYUJINX_VERSION: 1.1.1014
        RYUJINX_TARGET_RELEASE_CHANNEL_OWNER: flathub
        RYUJINX_TARGET_RELEASE_CHANNEL_REPO: org.ryujinx.Ryujinx
        RYUJINX_TARGET_RELEASE_CHANNEL_NAME: master
    build-commands:
    - |
      export PATH=$PATH:/run/build/Ryujinx/dotnet-sdk
      export RYUJINX_GIT_SHORT_HASH=$(git rev-parse --short HEAD)
      export RUNTIME_FRAMEWORK_VERSION=$(find nuget-sources -name 'microsoft.netcore.app.host.linux-x64.*' | grep -oP '(\d.\d.\d+.nupkg)' | grep -oP '(\d.\d.\d+)')
      sed -r --in-place "s/\%\%RYUJINX_BUILD_VERSION\%\%/$RYUJINX_VERSION/g;" src/Ryujinx.Common/ReleaseInformation.cs
      sed -r --in-place "s/\%\%RYUJINX_BUILD_GIT_HASH\%\%/$RYUJINX_GIT_SHORT_HASH/g;" src/Ryujinx.Common/ReleaseInformation.cs
      sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_NAME\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_NAME/g;" src/Ryujinx.Common/ReleaseInformation.cs
      sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_OWNER\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_OWNER/g;" src/Ryujinx.Common/ReleaseInformation.cs
      sed -r --in-place "s/\%\%RYUJINX_TARGET_RELEASE_CHANNEL_REPO\%\%/$RYUJINX_TARGET_RELEASE_CHANNEL_REPO/g;" src/Ryujinx.Common/ReleaseInformation.cs
      mkdir -p /app/bin
      dotnet publish -c Release -r $RUNTIME /p:DebugType=embedded src/Ryujinx /p:Version=$RYUJINX_VERSION /p:SourceRevisionId=$RYUJINX_GIT_SHORT_HASH /p:ExtraDefineConstants="DISABLE_UPDATER%2CFORCE_EXTERNAL_BASE_DIR" /p:RuntimeFrameworkVersion=$RUNTIME_FRAMEWORK_VERSION --self-contained --source nuget-sources
      if [ $? -ne 0 ]; then
          exit 1;
      fi;
      cp -r --remove-destination /run/build/Ryujinx/src/Ryujinx/bin/Release/net7.0/$RUNTIME/publish/* /app/bin/
      chmod +x /app/bin/Ryujinx.sh
      mkdir -p /app/lib/ffmpeg
      ln -s /usr/lib/x86_64-linux-gnu/libX11.so.6 /app/lib/libX11.so
      install -Dm755 ryujinx-wrapper /app/bin/ryujinx-wrapper
      install -Dm644 distribution/misc/Logo.svg /app/share/icons/hicolor/scalable/apps/ryujinx.svg
    sources:
    - type: archive
      only-arches:
      - x86_64
      dest: dotnet-sdk
      url: https://dotnetcli.azureedge.net/dotnet/Sdk/7.0.401/dotnet-sdk-7.0.401-linux-x64.tar.gz
      sha256: 4634fa4da7ae4e3dadb83e320a87fb26f0cb12a7ca02bf9f10e6c3c1c91d645c
      x-checker-data:
        type: rotating-url
        url: https://aka.ms/dotnet/7.0/dotnet-sdk-linux-x64.tar.gz
        pattern: https://dotnetcli.azureedge.net/dotnet/Sdk/^([\d\.a-z-]+)$/dotnet-sdk-^([\d\.a-z-]+)$-linux-x64.tar.gz
    - rd-submodules/ryujinx/nuget_sources.json
    - type: git
      url: https://github.com/Ryujinx/Ryujinx.git
      commit: 7ccff037e87f82f3461f3e1422235e29800eaa2f
    - type: file
      path: rd-submodules/ryujinx/ryujinx-wrapper

  # Ryujinx - END

  # Vita3K - START
  # Vita3K is writing some files in its own directory
  # So that is placed in /var/data/Vita3K and not in the readonly filesystem
  # This module is just fetching the file so it will be unique for this build

  - name: vita3k
    buildsystem: simple
    build-commands:
      # Creating an empty symlink that will point to Vita3K binary
      - ln -s /var/data/Vita3K/Vita3K ${FLATPAK_DEST}/bin/Vita3K
      # Copying the user icon
      - mkdir -p ${FLATPAK_DEST}/retrodeck
      - cp retrodeck.png ${FLATPAK_DEST}/retrodeck
      # preparing the vita3k zip for later
      - mv ubuntu-latest.zip ${FLATPAK_DEST}/retrodeck/vita3k.zip
    sources:
      - type: file
        url: https://github.com/Vita3K/Vita3K/releases/download/continuous/ubuntu-latest.zip
        sha256: VITA3KSHAPLACEHOLDER
      - type: file
        path: res/retrodeck.png

  # Vita3K - END

  # External manifests end

  - name: retrodeck
    buildsystem: simple
    build-commands:

      # Initializing RO retrodeck config folder
      - mkdir -p ${FLATPAK_DEST}/retrodeck

      # Prep the ES-DE and RetroArch config files - I will have to SED/XMLSTARLET them soon
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_find_rules.xml
      - cp es-configs/es_find_rules.xml /app/share/emulationstation/resources/systems/unix/
      - rm -rf /app/share/emulationstation/resources/systems/unix/es_systems.xml
      - cp es-configs/es_systems.xml /app/share/emulationstation/resources/systems/unix/
      # These must be put in home folder, managed by retrodeck.sh
      - cp es-configs/es_settings.xml ${FLATPAK_DEST}/retrodeck/es_settings.xml
      - mv -f -t ${FLATPAK_DEST}/retrodeck es-configs/rd_prepacks

      # Logo, res, move graphics directory away from default location so splash can be changed after build
      - mv -f -t ${FLATPAK_DEST}/retrodeck /app/share/emulationstation/resources/graphics
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash.svg
      - cp -f res/splash.svg ${FLATPAK_DEST}/retrodeck/graphics/splash-orig.svg
      - cp -rf res/extra_splashes/ ${FLATPAK_DEST}/retrodeck/graphics
      - cp -f res/icon.svg /app/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.svg
      - mv -f -t ${FLATPAK_DEST}/retrodeck res/binding_icons

      # RetroDECK core script
      - cp retrodeck.sh /app/bin/retrodeck.sh
      - chmod +x /app/bin/retrodeck.sh

      # Tools
      - mkdir -p /app/tools
      - cp -r tools/** /app/tools
      - find /app/tools -name '*.py|*.sh' -exec chmod +x {} \;     

      # Function libraries
      - mkdir -p /app/libexec
      - cp -r functions/** "/app/libexec/"

      # Desktop entries
      - cp net.retrodeck.retrodeck.desktop /app/share/applications/net.retrodeck.retrodeck.desktop
      - cp net.retrodeck.retrodeck.Configurator.desktop /app/share/applications/net.retrodeck.retrodeck.Configurator.desktop

      # Initializing default emulator configs
      - cp -r emu-configs ${FLATPAK_DEST}/retrodeck/emu-configs/

      # PICO-8 wrapper
      - cp ${FLATPAK_DEST}/retrodeck/emu-configs/pico-8/pico8-wrapper.sh /app/bin/pico8
      - chmod +x /app/bin/pico8

      # Needed for ffmpeg (RPCS3)
      - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg

      # Placing appdata
      - mkdir -p ${FLATPAK_DEST}/share/appdata
      - cp net.retrodeck.retrodeck.appdata.xml ${FLATPAK_DEST}/share/appdata

    sources:
      - type: git
        url: https://github.com/XargonWan/RetroDECK.git
        branch: THISBRANCH